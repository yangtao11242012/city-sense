# 智慧城市运行态势感知系统

## 项目介绍

智慧城市运行态势感知系统是一个基于 Vue 3 + TypeScript 的前端 AI 竞赛项目，旨在通过数据可视化和 AI 分析技术，帮助城市管理者实时掌握城市运行态势，快速识别问题并制定处置方案。

### 核心功能

- **数据管理**：支持城市事件和传感器数据的上传、验证、存储和查询
- **智能分析**：基于大语言模型的 AI 分析，提供问题归因、处置建议和优先级评估
- **态势感知**：实时大屏展示城市运行数据，包括地图、图表、趋势分析等
- **智能预警**：基于规则的自动预警系统，支持事件聚集、传感器异常等场景
- **对话助手**：AI 对话助手支持自然语言查询，结合数据上下文提供智能回答
- **运行简报**：AI 自动生成城市运行简报，支持 PDF 导出

### 技术特点

- 🚀 **现代化技术栈**：Vue 3 Composition API + TypeScript + Vite
- 📊 **丰富的数据可视化**：ECharts 图表库，支持多种图表类型
- 🤖 **AI 能力集成**：集成百度文心一言大模型，提供智能分析,使用cursor作为AI开发工具，使用豆包查询一些小问题
- 💾 **数据持久化**：支持 localStorage 和 IndexedDB
- 🎨 **现代化 UI**：Element Plus 组件库，响应式设计
- ⚡ **性能优化**：虚拟滚动、请求队列、结果缓存等

## 技术栈

### 核心框架
- **Vue 3.4** - 渐进式 JavaScript 框架
- **TypeScript 5.4** - 类型安全的 JavaScript 超集
- **Vite 5.1** - 下一代前端构建工具

### 状态管理与路由
- **Pinia 2.1** - Vue 官方推荐的状态管理库
- **Vue Router 4.3** - 官方路由管理器

### UI 组件库
- **Element Plus 2.11** - 基于 Vue 3 的组件库

### 数据可视化
- **ECharts 5.5** - 强大的数据可视化图表库

### AI 与 HTTP
- **Axios 1.6** - HTTP 客户端
- **百度文心一言 API** - 大语言模型服务

### 工具库
- **@vueuse/core 10.11** - Vue Composition API 工具集
- **dayjs 1.11** - 轻量级日期处理库
- **@tanstack/vue-virtual 3.0** - 虚拟滚动组件

### 文档导出
- **jsPDF 3.0** - PDF 生成库
- **html2canvas 1.4** - HTML 转 Canvas 库

## 项目结构

```
city-sense/
├── src/
│   ├── components/          # 公共组件
│   │   ├── AppHeader.vue           # 页面头部导航组件
│   │   ├── AIChatDialog.vue        # AI 对话助手对话框
│   │   ├── DailyReportDialog.vue   # 城市运行简报对话框
│   │   └── WarningNotification.vue # 预警通知组件
│   ├── views/               # 页面视图
│   │   ├── LoginView.vue           # 登录页面
│   │   ├── UploadView.vue          # 数据上传页面
│   │   ├── ListView.vue            # 数据列表页面
│   │   ├── DashboardView.vue       # 大屏展示页面
│   │   └── WarningsView.vue        # 预警管理页面
│   ├── stores/              # Pinia 状态管理
│   │   ├── dataStore.ts            # 数据存储（事件、传感器）
│   │   ├── warnStore.ts            # 预警管理存储
│   │   └── aiAnalysisStore.ts      # AI 分析历史记录存储
│   ├── services/            # 服务层
│   │   ├── ai.ts                   # AI 服务（文心一言 API 封装）
│   │   └── report.ts               # 城市运行简报生成服务
│   ├── router/              # 路由配置
│   ├── types/               # TypeScript 类型定义
│   ├── utils/               # 工具函数
│   │   ├── validation.ts           # 数据验证工具
│   │   └── geo.ts                  # 地理计算工具（距离计算等）
│   ├── App.vue              # 根组件
│   └── main.ts              # 入口文件
├── public/                  # 静态资源
├── .env                     # 环境变量配置（需自行创建）
└── package.json            # 项目配置
```

## 运行方式

### 环境要求

- Node.js >= 16.0.0
- npm >= 7.0.0 或 yarn >= 1.22.0

### 安装步骤

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd city-sense
   ```

2. **安装依赖**
   ```bash
   npm install
   # 或
   yarn install
   ```

3. **配置环境变量**
   
   在项目根目录创建 `.env` 文件：
   ```env
   # 百度文心一言 API Key
   VITE_WENXIN_API_KEY=your_api_key_here
   ```
   
   > **获取 API Key**：
   > 1. 访问 [百度智能云千帆大模型平台](https://cloud.baidu.com/product/wenxinworkshop)
   > 2. 注册/登录账号
   > 3. 创建应用并获取 API Key
   > 4. 将 API Key 填入 `.env` 文件

4. **启动开发服务器**
   ```bash
   npm run dev
   # 或
   yarn dev
   ```
   
   开发服务器启动后，访问 `http://localhost:5173`

5. **构建生产版本**
   ```bash
   npm run build
   # 或
   yarn build
   ```
   
   构建产物将输出到 `dist` 目录

6. **预览生产构建**
   ```bash
   npm run preview
   # 或
   yarn preview
   ```

### 默认登录信息

- **用户名**：`admin`
- **密码**：`123456`

> 登录成功后，系统会自动清空所有已上传的数据和预警信息，确保从干净的状态开始。

## 使用的大模型

### 百度文心一言 ERNIE-3.5-8K

本项目使用 **百度文心一言 ERNIE-3.5-8K** 大语言模型，通过百度智能云千帆大模型平台提供的 API 服务进行调用。

#### 模型特点

- **模型名称**：`ernie-3.5-8k`
- **上下文长度**：8K tokens
- **API 端点**：`https://qianfan.baidubce.com/v2/chat/completions`
- **调用方式**：RESTful API

#### 应用场景

1. **数据分析**：分析城市事件和传感器数据，提供问题归因和处置建议
2. **模式识别**：识别高频问题类型和问题高发区
3. **对话助手**：支持自然语言查询，结合数据上下文回答问题
4. **简报生成**：自动生成城市运行简报，包含问题汇总、热点区域、处置建议等

#### API 调用优化

- **请求队列**：管理并发请求，避免超过 API 限流
- **结果缓存**：5 分钟缓存机制，减少重复请求
- **重试机制**：自动重试失败的请求，处理限流和网络错误
- **错误处理**：友好的错误提示，支持限流、认证等错误场景

## Prompt 设计思路

### 1. AI 数据分析 Prompt

#### 设计目标
分析选定的城市事件和传感器数据，提供结构化的问题归因、处置建议和优先级评估。

#### Prompt 结构

```
System Message:
你是一个智慧城市运行态势分析专家，擅长分析城市事件和传感器数据，提供专业的问题归因和处置建议。

User Message:
你是一个智慧城市运行态势分析专家。请分析以下数据：

【事件数据】共 N 条
{
  "id": "EV20251112001",
  "type": "道路积水",
  "description": "...",
  "location": "朝阳区 建国路",
  "reportTime": "2025-11-12T08:30:00",
  "status": "未处理"
}
...

【传感器数据】共 M 条
{
  "sensorId": "SN-WATER-001",
  "type": "积水监测",
  "value": 42.3,
  "unit": "cm",
  "threshold": 30,
  "location": "朝阳区 建国路",
  "timestamp": "2025-11-12T08:28:00",
  "status": "异常"
}
...

请按照以下格式返回分析结果（必须使用JSON格式，不要包含任何其他文字）：
{
  "cause": "问题归因分析（详细分析这些数据反映的问题原因）",
  "suggestion": "处置建议（提供具体的处置措施和建议）",
  "priority": "high|medium|low",
  "estimatedTime": "预计处理时间（如：2小时、1天等）"
}
```

#### 设计要点

- **数据简化**：只传递关键字段（ID、类型、描述、位置、时间、状态），减少 token 消耗
- **数据量限制**：最多分析 10 条数据，超出部分提示 AI 考虑整体情况
- **结构化输出**：严格要求 JSON 格式，便于解析和展示
- **多场景支持**：支持单条数据分析和批量数据分析

### 2. 全局模式分析 Prompt

#### 设计目标
分析所有数据，识别高频问题类型和问题高发区，提供模式总结和针对性建议。

#### Prompt 结构

```
System Message:
你是一个智慧城市运行态势分析专家，擅长识别城市问题模式和热点区域。

User Message:
请分析以下城市运行数据，识别问题模式和热点区域：

【数据统计】
- 事件总数：N
- 异常传感器数：M

【高频问题类型】
- 道路积水: 15次 (30%)
- 噪音污染: 10次 (20%)
...

【问题高发区】
- 朝阳区: 20个问题，主要类型：道路积水、噪音污染，严重程度：高
- 海淀区: 15个问题，主要类型：空气污染，严重程度：中
...

请返回JSON格式的分析结果：
{
  "summary": "问题模式总结（分析这些高频问题类型和高发区的共同特征和原因）",
  "suggestions": "针对性建议（针对高频问题类型和高发区提出具体的治理建议）"
}
```

#### 设计要点

- **先统计后分析**：先进行本地统计分析，再让 AI 进行深度分析
- **结构化输入**：提供统计结果而非原始数据，提高分析效率
- **模式识别**：重点识别高频问题类型和问题高发区
- **针对性建议**：基于识别出的模式提供具体治理建议

### 3. AI 对话助手 Prompt

#### 设计目标
支持自然语言查询，结合当前数据上下文回答问题，支持上下文记忆。

#### Prompt 结构

```
System Message:
你是一个智慧城市运行态势分析助手，可以帮助用户查询和分析城市运行数据。请根据用户的问题，结合提供的数据信息，给出准确、详细的回答。

[数据上下文摘要]
当前数据概览：
- 事件总数: N
- 传感器总数: M
- 紧急事件数: X
- 异常设备数: Y

事件类型分布：
  - 道路积水: N1起
  - 噪音污染: N2起
  ...

区域分布：
  - 朝阳区: M1个问题
  - 海淀区: M2个问题
  ...

紧急事件详情（前10条）：
  - 道路积水 (朝阳区 建国路): ...
  ...

异常传感器详情（前10条）：
  - 积水监测 (朝阳区 建国路): 当前值42.3cm，阈值30cm
  ...

[对话历史]
User: 今天哪些区域积水最严重？
Assistant: 根据当前数据，朝阳区积水问题最为严重...
User: 怎么处理？

[当前问题]
User: [用户输入的问题]
```

#### 设计要点

- **数据摘要**：提供数据统计和关键信息摘要，而非完整数据
- **上下文记忆**：支持对话历史，实现多轮对话
- **自然语言**：支持用户用自然语言提问，AI 理解并回答
- **数据关联**：结合当前数据上下文，提供准确回答

### 4. 城市运行简报生成 Prompt

#### 设计目标
基于当日数据自动生成结构化的城市运行简报，包含问题汇总、热点区域、处置建议、预警回顾。

#### Prompt 结构

```
User Message:
请根据以下2025-11-12的城市运行数据，生成一份专业的《城市运行简报》。

【数据统计】
- 事件总数: N
- 传感器总数: M
- 紧急事件数: X
- 异常设备数: Y

【事件类型分布】
  - 道路积水: N1起
  ...

【区域问题分布】
  - 朝阳区: M1个问题
  ...

【紧急事件详情（前10条）】
  - 道路积水 (朝阳区 建国路): ...
  ...

【异常传感器详情（前10条）】
  - 积水监测 (朝阳区 建国路): 当前值42.3cm，阈值30cm
  ...

【预警信息】
  - 朝阳区积水预警 (高优先级): ... - 位置: 朝阳区 建国路
  ...

请按照以下格式生成简报，要求：
1. **问题汇总**：总结今日主要问题类型、数量、严重程度
2. **热点区域**：识别问题集中的区域，说明主要问题类型和数量
3. **处置建议**：针对发现的问题，提供具体的处置建议和措施
4. **预警回顾**：总结今日预警情况，分析预警原因和应对措施

请返回JSON格式：
{
  "problemSummary": "问题汇总内容（详细描述今日主要问题）",
  "hotspotAreas": "热点区域分析（说明哪些区域问题集中，原因分析）",
  "suggestions": "处置建议（提供具体的处置措施和建议）",
  "warningReview": "预警回顾（总结预警情况，分析原因和应对措施）"
}
```

#### 设计要点

- **结构化输出**：严格要求 JSON 格式，包含四个固定字段
- **数据摘要**：提供关键数据统计，而非完整数据列表
- **多维度分析**：从问题类型、区域分布、紧急程度等维度分析
- **可读性**：生成的简报内容要求专业、详细、可读

### Prompt 设计原则

1. **明确角色定位**：通过 System Message 明确 AI 的角色和专业领域
2. **结构化输入**：提供结构化的数据摘要，而非原始数据
3. **严格输出格式**：要求 JSON 格式输出，便于解析和展示
4. **数据量控制**：限制输入数据量，避免超出 token 限制
5. **错误处理**：设计多层次的解析机制，处理各种输出格式
6. **上下文管理**：合理管理对话历史和数据上下文

## 功能模块

### 1. 登录页面 (LoginView)

- 用户登录验证
- 默认账号：`admin` / `123456`
- 登录成功后自动清空数据，确保干净状态

### 2. 数据上传 (UploadView)

- **文件上传**：支持拖拽/点击上传 JSON 文件
- **数据验证**：
  - JSON 格式验证
  - 字段完整性检查
  - 经纬度范围验证（中国境内）
  - 时间格式验证（ISO 8601）
- **数据持久化**：使用 Pinia store 存储数据
- **统计概览**：
  - 事件数据：事件总数、类型分布、区域分布
  - 传感器数据：异常数量、设备在线率
- **自动预警**：数据上传后自动触发预警检查

### 3. 数据列表 (ListView)

- **多视图切换**：合并视图、仅事件、仅传感器
- **高级筛选**：
  - 时间段筛选（日期时间范围选择器）
  - 区域筛选
  - 类型筛选
  - 状态筛选
  - 关键词搜索
- **数据展示**：
  - 虚拟滚动支持大数据量
  - 分页显示（每页 20 条）
  - 数据标记：
    - 🔗 高置信度关联事件（传感器异常与附近事件自动关联）
    - 🔥 高频问题类型（AI 自动识别）
    - 📍 问题高发区（AI 自动识别，支持严重程度标记）
- **批量操作**：
  - 多选功能
  - 全选当前页
  - 批量 AI 分析
- **AI 分析**：
  - 单条/批量数据分析
  - 全局模式分析（识别高频问题类型和问题高发区）
  - 分析结果展示：
    - 问题归因
    - 处置建议（支持结构化显示）
    - 优先级评估
    - 预计处理时间
    - 高频问题类型列表
    - 问题高发区列表
  - 历史分析记录（支持查看、删除、清空）
- **异常关联分析**：
  - 自动关联传感器异常与附近事件（500 米内）
  - 基于类型相关性判断（如：积水传感器 ↔ 道路积水事件）
  - 高置信度关联标记
- **数据导出**：支持导出筛选后的数据为 JSON 文件

### 4. 大屏展示 (DashboardView)

- **关键指标卡片**：
  - 今日事件数
  - 异常设备数
  - 高优先级问题数
  - 平均响应时长（模拟）
- **数据可视化**：
  - 问题分布热力图（地图 + 热力点）
  - 近 7 天问题趋势（折线图）
  - 事件类型分布（饼图，支持滚动图例）
  - 区域分布统计（饼图，支持滚动图例）
  - 传感器类型分布（饼图，支持滚动图例）
  - 问题类型环形图（事件 vs 传感器异常分类对比，支持滚动图例）
  - 实时事件流（滚动列表）
- **空状态处理**：所有图表支持无数据时的友好提示
- **实时更新**：数据变化时自动刷新图表

### 5. 预警管理 (WarningsView)

- **预警列表**：
  - 预警状态筛选（待处理、处理中、已解决）
  - 预警级别筛选（高、中、低）
  - 预警统计卡片
- **预警类型**：
  - 事件聚集预警（同一区域 1 小时内同类事件达到阈值）
  - 传感器连续异常预警（传感器连续多次异常）
  - 关联预警（传感器异常与事件关联）
- **预警操作**：
  - 开始处理
  - 标记已解决
  - AI 分析（调用 AI 分析关联数据）
  - 应用 AI 建议到预警
  - 删除预警
- **预警配置**：
  - 事件聚集阈值
  - 时间窗口（小时）
  - 传感器连续异常次数
  - 自动检查开关
  - 检查间隔（秒）
- **预警导出**：支持导出预警数据为 JSON 文件

### 6. AI 对话助手 (AIChatDialog)

- **自然语言查询**：支持用户用自然语言提问
- **数据上下文**：自动结合当前上传的数据回答问题
- **上下文记忆**：支持多轮对话，记住对话历史
- **智能回答**：AI 基于数据统计和详情提供准确回答
- **可视化建议**：AI 可以建议查看哪些图表或数据

### 7. 城市运行简报 (DailyReportDialog)

- **自动生成**：数据上传后自动生成当日简报
- **AI 生成内容**：
  - 问题汇总：总结今日主要问题类型、数量、严重程度
  - 热点区域：识别问题集中的区域，说明主要问题类型
  - 处置建议：针对发现的问题提供具体处置措施（支持结构化显示）
  - 预警回顾：总结今日预警情况，分析原因和应对措施
- **PDF 导出**：支持导出简报为 PDF 文件
- **手动重新生成**：支持手动触发重新生成简报

## 数据格式

### 城市事件 (city_events.json)

```json
[
  {
    "id": "EV20251112001",
    "type": "道路积水",
    "description": "建国路与朝阳路交叉口积水严重，水深约30cm",
    "location": {
      "district": "朝阳区",
      "street": "建国路",
      "lat": 39.9087,
      "lng": 116.4075
    },
    "reportTime": "2025-11-12T08:30:00",
    "reporterType": "市民APP",
    "status": "未处理"
  }
]
```

**字段说明**：
- `id`: 事件唯一标识
- `type`: 事件类型（如：道路积水、噪音污染、空气污染等）
- `description`: 事件描述
- `location`: 位置信息
  - `district`: 行政区（如：朝阳区、海淀区）
  - `street`: 街道名称
  - `lat`: 纬度（范围：18.0 - 54.0，中国境内）
  - `lng`: 经度（范围：73.0 - 135.0，中国境内）
- `reportTime`: 上报时间（ISO 8601 格式）
- `reporterType`: 上报来源（如：市民APP、12345热线等）
- `status`: 处理状态（如：未处理、已派单、处理中、紧急等）

### 传感器数据 (sensor_data.json)

```json
[
  {
    "sensorId": "SN-WATER-001",
    "type": "积水监测",
    "location": {
      "district": "朝阳区",
      "street": "建国路",
      "lat": 39.9087,
      "lng": 116.4075
    },
    "value": 42.3,
    "unit": "cm",
    "threshold": 30,
    "timestamp": "2025-11-12T08:28:00",
    "status": "异常"
  }
]
```

**字段说明**：
- `sensorId`: 传感器唯一标识
- `type`: 传感器类型（如：积水监测、空气质量传感器、噪音传感器等）
- `location`: 位置信息（格式同事件数据）
- `value`: 传感器当前值
- `unit`: 数值单位（如：cm、dB、μg/m³等）
- `threshold`: 异常阈值
- `timestamp`: 数据采集时间（ISO 8601 格式）
- `status`: 传感器状态（正常/异常）

## 环境变量

创建 `.env` 文件并配置：

```env
# 百度文心一言 API Key
# 获取方式：访问 https://cloud.baidu.com/product/wenxinworkshop
VITE_WENXIN_API_KEY=your_api_key_here
```

## 开发说明

### 代码规范

- 使用 TypeScript 进行类型检查
- 遵循 Vue 3 Composition API 最佳实践
- 使用 ESLint 进行代码检查：`npm run lint`

### 性能优化

- **虚拟滚动**：大数据量列表使用虚拟滚动
- **请求队列**：AI API 请求使用队列管理，避免限流
- **结果缓存**：AI 分析结果缓存 5 分钟
- **按需加载**：路由懒加载，组件按需导入
- **数据摘要**：AI Prompt 中使用数据摘要而非完整数据

### 浏览器兼容性

- Chrome >= 90
- Firefox >= 88
- Safari >= 14
- Edge >= 90

## 许可证

MIT
